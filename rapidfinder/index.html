<html>
<head>
 <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet-src.js" crossorigin=""></script>
    <script src="https://kit.fontawesome.com/7a4305c6cb.js" crossorigin="anonymous"></script>

        <script src="https://unpkg.com/esri-leaflet@2.3.0/dist/esri-leaflet.js"
    integrity="sha512-1tScwpjXwwnm6tTva0l0/ZgM3rYNbdyMj5q6RSQMbNX6EUMhYDE3pMRGZaT41zHEvLoWEK7qFEJmZDOoDMU7/Q=="
    crossorigin=""></script>

    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.14/dist/esri-leaflet-geocoder.css"
    integrity="sha512-v5YmWLm8KqAAmg5808pETiccEohtt8rPVMGQ1jA6jqkWVydV5Cuz3nJ9fQ7ittSxvuqsvI9RSGfVoKPaAJZ/AQ=="
    crossorigin="">
  <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.14/dist/esri-leaflet-geocoder.js"
    integrity="sha512-uK5jVwR81KVTGe8KpJa1QIN4n60TsSV8+DPbL5wWlYQvb0/nYNgSOg9dZG6ViQhwx/gaMszuWllTemL+K+IXjg=="
    crossorigin=""></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css" />

 <style>

 #map{
 width:100%;
 height: 100%;
 position: absolute
 }
.mapboxgl-ctrl-geocoder {
    width: 300px!important;
}
.mapboxgl-ctrl-icon{
        position: static !important;
      }
      .mapboxgl-ctrl-logo{
        display:none !important;
        }
      .mapboxgl-ctrl-bottom-right{
        display:none !important;
        }
      .mapboxgl-ctrl-bottom-left{
        /*display:none !important;*/
        }

 body{
 	margin: 0 !important;

 }
 
 table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
  font-size:small
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #f9f9f9;
}

 .marker {width:0; height:0;}

.marker  span {
  display:flex;
  justify-content:center;
  align-items:center;
  box-sizing:border-box;
  width: 30px;
  height: 30px;
  color:#fff;
  background: #693;
  border:solid 2px;
  border-radius: 0 70% 70%;
  box-shadow:0 0 2px #000;
  cursor: pointer;
  transform-origin:0 0;
  transform: rotateZ(-135deg);
}

.marker b {transform: rotateZ(135deg)}

.mapboxgl-popup {
  max-width: 200px;
}

.mapboxgl-popup-content {
  text-align: center;
  font-family: 'Open Sans', sans-serif;
  padding: 5px;
}

   h3{
      margin:0;
    }

    p{margin:0;}
 </style>

</head>
<body>
<div id='map'>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoia3BjbHluZSIsImEiOiJjanN3MzlpY2EwZGpjM3lsaGNhb3NqY3JmIn0._sGjIhmL5Xt08WIMWRsSsg';
      var map = new mapboxgl.Map({
        container: 'map'
        , style: 'mapbox://styles/mapbox/light-v10'
        , center: [-73.978776,40.688397]
        , zoom: 12
        , pitch: 0
        , bearing: 0
        , maxPitch: 85
      });


geocoder = new MapboxGeocoder({
accessToken: mapboxgl.accessToken,
mapboxgl: mapboxgl,
marker: false
})


map.addControl(new mapboxgl.NavigationControl());

window.mapMarkers = []

function getCVS(x,y){

    geojson = {
    "type": "FeatureCollection",
    "features": [],
    "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
  }

    let data = {
    "getStoreDetailsAndInventoryRequest":{
      "header":{"apiKey":"a2ff75c6-2da7-4299-929d-d670d827ab4a","apiSecret":"a8df2d6e-b11c-4b73-8bd3-71afc2515dae","appName":"CVS_WEB","channelName":"WEB","deviceType":"DESKTOP","version":"1.0","deviceToken":"device12345","lineOfBusiness":"RETAIL","responseFormat":"JSON","securityType":"apiKey","source":"CVS_WEB","type":"rdp"},
      "productId": "550147",
      "geolatitude":x,
      "geolongitude":y
    }
  };


    axios.post("https://www.cvs.com/RETAGPV1/Inventory/V1/getStoreDetailsAndInventory", JSON.stringify(data)).then(function(response){
      response.data.atgResponse.forEach(function(s){


    name = "CVS"
    address = s.storeAddress + ", " + s.City +", " + s.State + " " + s.Zipcode

    fetch('https://api.mapbox.com/geocoding/v5/mapbox.places/' + address + '.json?access_token=pk.eyJ1Ijoia3BjbHluZSIsImEiOiJjanN3MzlpY2EwZGpjM3lsaGNhb3NqY3JmIn0._sGjIhmL5Xt08WIMWRsSsg').then(response => response.json()).then(function(c){

      coords = c.features[0].center


      store = {
      "type": "Feature",
      "properties": {
        "name": name,
        "address": c.features[0].place_name,
        "count" : s.Qty
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          coords[0],
          coords[1]
        ]
      }
    }

    geojson.features.push(store)


    })

    geojson.features.forEach(function(marker, i) {

    // create a HTML element for each feature
    var el = document.createElement('div');
    el.className = 'marker';
    el.innerHTML = '<span><b>' + marker.properties.count + '</b></span>'

    // make a marker for each feature and add it to the map
    marker = new mapboxgl.Marker(el)
      .setLngLat(marker.geometry.coordinates)
      .setPopup(new mapboxgl.Popup({
          offset: 25
        }) // add popups
        .setHTML('<h3>' + marker.properties.name + '</h3><p>' + marker.properties.address + '</p>'))
      .addTo(map);

     mapMarkers.push(marker)
  });

    



      })
    })
    // console.log(response.data);

}

function getWalgreens(x,y){

	geojson = {
	  "type": "FeatureCollection",
	  "features": [],
	  "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
	}

	skus = [{name:"BinaxNow", sku:"400635630", plnId:"40000917187"},{name:"On/Go", sku:"400642185",plnId:"40000840982"},{name:"Quickvue", sku:"400637449",plnId:"40000999566"}]
	
	skus.forEach(function(sku){
	

	fetch('https://www.walgreens.com/locator/v1/search/stores/inventory?requestor=pdpui', {
      method: 'POST',
      body: JSON.stringify({
		"requestType":"filterInStockStores",
			"inStockOnly":"true",
			"skuId":sku.sku,
			"p":"1",
			"s":"50",
			"r":"25",
			"plnId":sku.plnId,
			"sameday":"true",
			"excludeEmergencyClosed":"true",
			"lat":x,
			"lng":y,
			"q":"10001"}),
      headers: {
        'Content-type': 'application/json; charset=UTF-8',
      },
    }).then(response => response.json()).then(function(data){


    data.results.forEach(function(d){


	inventory = d.inventory.inventoryCount
    latitude = d.latitude
    longitude = d.longitude
    name = d.store.brand
    address = d.store.address.street + ", " + d.store.address.city +", " + d.store.address.state + " " + d.store.address.zip

	result = window.geojson.features.filter(d => d.properties.address == address)

	if(result.length == 0){
    store = {
      "type": "Feature",
      "properties": {
        "name": name,
        "address": address,
        "count" : inventory
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          +longitude,
          +latitude
        ]
      }
    }
	
	store.properties[String(sku.name)] = d.inventory.inventoryCount

    geojson.features.push(store)
	
	 geojson.features.forEach(function(marker, i) {

	  // create a HTML element for each feature
	  var el = document.createElement('div');
	  el.className = 'marker';
	  el.innerHTML = '<span><b>' + marker.properties.count + '</b></span>'

	  // make a marker for each feature and add it to the map
	  
	  html = '<h3>' + marker.properties.name + '</h3><p>' + marker.properties.address + '</p>'
	 
	  
	  marker = new mapboxgl.Marker(el)
	    .setLngLat(marker.geometry.coordinates)
	    .setPopup(new mapboxgl.Popup({
	        offset: 25
	      }) // add popups
	      .setHTML(html))
	    .addTo(map);

	   mapMarkers.push(marker)
	});
	}else{
	result[0].properties[String(sku.name)] = d.inventory.inventoryCount
	result[0].properties.count = result[0].properties.count + d.inventory.inventoryCount
	
	window.mapMarkers.forEach(d => d.remove())
	
	geojson.features.forEach(function(marker, i) {
	
		html = '<h3>' + marker.properties.name + '</h3><p>' + marker.properties.address + '</p>'
	  
	  item = ""
	  skus.forEach(function(r){
	  if (marker.properties[r.name] !== undefined){
	  item = item + "<tr><td>" + r.name + "</td><td>" + String(marker.properties[r.name]) +"</td></tr>"
	  }
	  })
	  
	  	  
	  table = "<br><table><tr><th>Brand</th><th>Inventory</th></tr>" + item + "</table>"

	  // create a HTML element for each feature
	  var el = document.createElement('div');
	  el.className = 'marker';
	  el.innerHTML = '<span><b>' + marker.properties.count + '</b></span>'

	  // make a marker for each feature and add it to the map
	  marker = new mapboxgl.Marker(el)
	    .setLngLat(marker.geometry.coordinates)
	    .setPopup(new mapboxgl.Popup({
	        offset: 25
	      }) // add popups
	      .setHTML(html + table))
	    .addTo(map);

	   mapMarkers.push(marker)
	});
	
	}

    })


	

    });
	
	})

      

}



map.on('load', function () {


map.addControl(geocoder,'top-left');


geocoder.on('result', function(ev) {

	if(window.mapMarkers != undefined){
	window.mapMarkers.forEach(d => d.remove())
}

	getWalgreens(ev.result.center[1],ev.result.center[0])
  getCVS(String(ev.result.center[1]),String(ev.result.center[0]))

});









    })




      





    
</script>
</body>
</html>
